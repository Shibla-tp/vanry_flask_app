<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crypto Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; transition: background .25s, color .25s; }
  .dark { background:#0f1724; color:#e6eef8; }
  .container { max-width:1100px; margin:24px auto; padding:0 16px; }
  h1 { margin:0 0 12px 0; font-size:24px; }
  .controls { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; align-items:center; }
  .controls input { padding:8px; border-radius:6px; border:1px solid #ccc; min-width:120px; }
  .controls button { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; background:#007bff; color:#fff;}
  table { width:100%; border-collapse:collapse; background:transparent; }
  th, td { text-align:left; padding:10px 8px; border-bottom:1px solid rgba(0,0,0,0.06); }
  th { cursor:pointer; user-select:none; font-weight:600; }
  .coin-img { width:22px; height:22px; vertical-align:middle; margin-right:8px; }
  tbody tr { transition: background .15s, transform .08s; cursor:pointer; }
  tbody tr:hover { background: rgba(0,123,255,0.06); transform:translateY(-1px); }
  .dark tbody tr:hover { background: rgba(0,123,255,0.12); }
  .sort-icon { margin-left:6px; font-size:12px; color:gray; }
  .active-sort { color:#007bff; }

  /* Modal */
  .modal { 
    display:none; 
    position:fixed; 
    inset:0; 
    background:rgba(0,0,0,0.6); 
    align-items:center; 
    justify-content:center; 
    z-index:999; 
    padding: 10px;
  }
  .modal-content { 
    background:#fff; 
    width:95%; 
    max-width:900px; 
    border-radius:10px; 
    padding:18px; 
    position:relative; 
    box-sizing:border-box;
    max-height:90vh; 
    overflow-y:auto;
  }
  .dark .modal-content { background:#0b1220; color:#e6eef8; }

  .close-btn { position:absolute; right:12px; top:10px; cursor:pointer; font-size:20px; }
  .chart-tabs { display:flex; gap:8px; justify-content:center; margin-bottom:8px; }
  .chart-tabs button { padding:6px 12px; border-radius:6px; border:1px solid #ddd; background:#f3f6fb; cursor:pointer; }
  .chart-tabs button.active { background:#007bff; color:#fff; border-color:#007bff; }
  .dark .chart-tabs button { background:#14202b; border-color:#22313f; color:#cbd6e6; }
  .dark .chart-tabs button.active { background:#007bff; color:#fff; border-color:#007bff; }

  .theme-btn { position:fixed; right:14px; top:12px; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center;
               background:#f1f5f9; box-shadow:0 6px 18px rgba(2,6,23,.08); cursor:pointer; font-size:18px; }
  .dark .theme-btn { background:#0f1724; color:#fff; box-shadow:none; }

  #modalOpinion {
    margin-top:14px;
    padding:12px;
    border-radius:6px;
    background:#f8f9fc;
    font-size:14px;
    line-height:1.4;
  }
  .dark #modalOpinion {
    background:#141d2c;
  }

  @media (max-width:768px){
    .modal-content {
      width:100%; 
      height:auto; 
      max-height:85vh; 
      border-radius:8px;
      padding:12px;
    }
    .chart-tabs button {
      flex:1; 
      font-size:14px;
    }
    #modalChart {
      height:200px !important;
    }
  }

  @media (max-width:480px){
    .modal-content {
      padding:10px;
      font-size:14px;
    }
    h3#modalTitle {
      font-size:16px;
    }
    #modalOpinion {
      font-size:13px;
    }
  }
</style>
</head>
<body>
<div class="theme-btn" id="themeBtn">üåô</div>

<div class="container">
  <h1>AI-Powered Crypto Dashboard</h1>

  <div class="controls">
    <input id="searchInput" placeholder="Search name or symbol" />
    <input id="minPrice" type="number" placeholder="Min price" />
    <input id="maxPrice" type="number" placeholder="Max price" />
    <button id="applyBtn">Apply</button>
    <button id="resetBtn">Reset</button>
  </div>

  <table>
    <thead>
      <tr>
        <th onclick="sortTable(0)">Coin <span id="icon0" class="sort-icon"></span></th>
        <th onclick="sortTable(1)">Price (USDT) <span id="icon1" class="sort-icon"></span></th>
        <th onclick="sortTable(2)">24h % <span id="icon2" class="sort-icon"></span></th>
        <th onclick="sortTable(3)">24h Volume <span id="icon3" class="sort-icon"></span></th>
        <th onclick="sortTable(4)">Market Cap <span id="icon4" class="sort-icon"></span></th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal" id="chartModal">
  <div class="modal-content">
    <div class="close-btn" id="closeModal">‚úñ</div>
    <h3 id="modalTitle">Coin Chart</h3>
    <div class="chart-tabs">
      <button id="tab7" onclick="loadChart(curCoinId, curCoinName,7)">7D</button>
      <button id="tab30" class="active" onclick="loadChart(curCoinId, curCoinName,30)">30D</button>
      <button id="tab90" onclick="loadChart(curCoinId, curCoinName,90)">90D</button>
    </div>
    <canvas id="modalChart" height="260"></canvas>
    <div id="modalInfo" style="margin-top:10px;font-size:14px;"></div>
    <div id="modalOpinion"><i>Loading AI investment opinion...</i></div>
  </div>
</div>

<script>
let coins = [];
let filtered = [];
let curCoinId = null;
let curCoinName = '';
let sortState = { col: null, asc: true };
let modalChart = null;

// fetch coins (on load)
async function loadCoins(){
  try{
    const res = await fetch('/api/coins');
    const data = await res.json();
    coins = Array.isArray(data) ? data : [];
    filtered = coins.slice();
    renderTable(filtered);
  }catch(e){
    console.error('Failed to load coins', e);
  }
}

function renderTable(list){
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';
  list.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img class="coin-img" src="${c.image}" alt="logo" /> ${c.name} <small style="color:#666">(${(c.symbol||'').toUpperCase()})</small></td>
      <td>$${Number(c.current_price).toLocaleString()}</td>
      <td style="color:${(c.price_change_percentage_24h||0)>=0 ? 'green':'red'}">${(c.price_change_percentage_24h||0).toFixed(2)}%</td>
      <td>$${Number(c.total_volume||0).toLocaleString()}</td>
      <td>$${Number(c.market_cap||0).toLocaleString()}</td>
    `;
    tr.addEventListener('click', ()=> openModal(c.id, c.name));
    tbody.appendChild(tr);
  });
}

// search/filter
function applyFilters(){
  const q = (document.getElementById('searchInput').value||'').toLowerCase();
  const min = parseFloat(document.getElementById('minPrice').value) || -Infinity;
  const max = parseFloat(document.getElementById('maxPrice').value) || Infinity;
  filtered = coins.filter(c => {
    const name = (c.name||'').toLowerCase();
    const sym = (c.symbol||'').toLowerCase();
    const price = Number(c.current_price || 0);
    return (name.includes(q) || sym.includes(q)) && price >= min && price <= max;
  });
  if(sortState.col !== null) applySort(sortState.col, false);
  renderTable(filtered);
}

document.getElementById('applyBtn').addEventListener('click', applyFilters);
document.getElementById('resetBtn').addEventListener('click', ()=> {
  document.getElementById('searchInput').value = '';
  document.getElementById('minPrice').value = '';
  document.getElementById('maxPrice').value = '';
  filtered = coins.slice();
  renderTable(filtered);
});

// sorting helpers
function sortTable(colIndex){
  sortState.col = colIndex;
  sortState.asc = (sortState.col === colIndex) ? !sortState.asc : true;
  applySort(colIndex, true);
}
function applySort(colIndex, toggleIcon){
  const keyMap = {
    0: (a,b)=> a.name.localeCompare(b.name),
    1: (a,b)=> Number(a.current_price) - Number(b.current_price),
    2: (a,b)=> (a.price_change_percentage_24h||0) - (b.price_change_percentage_24h||0),
    3: (a,b)=> (a.total_volume||0) - (b.total_volume||0),
    4: (a,b)=> (a.market_cap||0) - (b.market_cap||0)
  };
  filtered.sort((a,b) => sortState.asc ? keyMap[colIndex](a,b) : keyMap[colIndex](b,a));
  if(toggleIcon) updateSortIcons(colIndex);
  renderTable(filtered);
}
function updateSortIcons(activeIndex){
  [0,1,2,3,4].forEach(i=>{
    const el = document.getElementById('icon'+i);
    if(!el) return;
    el.textContent = i===activeIndex ? (sortState.asc ? '‚ñ≤' : '‚ñº') : '';
    if(i===activeIndex) el.classList.add('active-sort'); else el.classList.remove('active-sort');
  });
}

// modal + chart
const modal = document.getElementById('chartModal');
const modalTitle = document.getElementById('modalTitle');
const modalInfo = document.getElementById('modalInfo');
const modalOpinion = document.getElementById('modalOpinion');
const chartCtx = document.getElementById('modalChart').getContext('2d');

function openModal(coinId, coinName){
  curCoinId = coinId;
  curCoinName = coinName;
  modalTitle.textContent = `${coinName} ‚Äî Price Chart`;
  document.getElementById('chartModal').style.display = 'flex';
  setActiveTab('tab30'); 
  loadChart(coinId, coinName, 30);
  const coin = coins.find(c=>c.id===coinId);
  if(coin){
    modalInfo.innerHTML = `
      Price: <b>$${Number(coin.current_price).toLocaleString()}</b> ‚Ä¢ 
      24h: <span style="color:${(coin.price_change_percentage_24h||0)>=0 ? 'green':'red'}">${(coin.price_change_percentage_24h||0).toFixed(2)}%</span><br>
      Volume (24h): <b>$${Number(coin.total_volume||0).toLocaleString()}</b> ‚Ä¢ 
      Market Cap: <b>$${Number(coin.market_cap||0).toLocaleString()}</b>
    `;
  } else {
    modalInfo.innerHTML = '';
  }
  // fetch AI opinion
  modalOpinion.innerHTML = "<i>Loading AI investment opinion...</i>";
  fetch(`/api/opinion/${coinId}`)
    .then(r=>r.json())
    .then(d=>{
      modalOpinion.textContent = d.opinion || "‚ö†Ô∏è No opinion available.";
    })
    .catch(e=>{
      modalOpinion.textContent = "‚ö†Ô∏è Failed to load AI opinion.";
    });
}
document.getElementById('closeModal').addEventListener('click', ()=> modal.style.display = 'none');

function setActiveTab(id){
  ['tab7','tab30','tab90'].forEach(t => document.getElementById(t).classList.remove('active'));
  if(id) document.getElementById(id).classList.add('active');
}

async function loadChart(coinId, coinName, days){
  if(!coinId) return;
  setActiveTab('tab'+days);
  try{
    const res = await fetch(`/api/coin/${coinId}/chart?days=${days}`);
    const data = await res.json();
    const labels = (data.prices||[]).map(p => new Date(p[0]).toLocaleDateString());
    const prices = (data.prices||[]).map(p => p[1]);
    if(modalChart) modalChart.destroy();
    modalChart = new Chart(chartCtx, {
      type:'line',
      data: {
        labels,
        datasets: [{
          label: `${coinName} ‚Äî ${days}D`,
          data: prices,
          borderColor:'#007bff',
          backgroundColor:'rgba(0,123,255,0.15)',
          tension:0.3,
          fill:true
        }]
      },
      options: { responsive:true, plugins:{ legend:{ display:true } } }
    });
  }catch(e){
    console.error('chart load failed', e);
  }
}

// theme toggle
const themeBtn = document.getElementById('themeBtn');
if(localStorage.getItem('theme') === 'dark'){ document.body.classList.add('dark'); themeBtn.textContent='‚òÄÔ∏è'; }
themeBtn.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  themeBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
});

// init
loadCoins();
</script>
</body>
</html>
